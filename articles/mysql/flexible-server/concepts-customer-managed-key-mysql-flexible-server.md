---
title: Data encryption with customer managed key - Azure Database for MySQL flexible server Preview
description: Learn which data encryption with customer-managed keys for Azure Database for MySQL flexible server enables you to bring your own key (BYOK) for data protection at rest and allows organizations to implement separation of duties in the management of keys and data.
author: markingmyname
ms.author: maghan
ms.reviewer: maghan
ms.date: 09/12/2022
ms.service: mysql
ms.subservice: flexible-server
ms.topic: conceptual
---

# Data encryption with customer managed key - Azure Database for MySQL flexible server Preview

Data encryption with customer-managed keys for Azure Database for MySQL flexible server enables you to bring your own key (BYOK) for data protection at rest and allows organizations to implement separation of duties in the management of keys and data. With customer-managed key, customer is responsible for and in a full control of a key lifecycle management (key creation, upload, rotation, deletion), key usage permissions, and auditing of operations on keys.

Data encryption with customer-managed keys is set at the server-level. For a given server, a customer-managed key, called the key encryption key (KEK), is used to encrypt the data encryption key (DEK) used by the service. The KEK is an asymmetric key stored in a customer-owned and customer-managed[Azure Key Vault](/azure/key-vault/general/security-features)instance. Key Vault is highly available and scalable secure storage for RSA cryptographic keys, optionally backed by FIPS 140-2 Level 2 validated hardware security modules (HSMs). It doesn't allow direct access to a stored key but provides services of encryption/decryption using the key to the authorized entities. The key can be generated by the key vault, imported, or transferred to the key vault from an on-premises HSM device.

## Terminology and description

**Data encryption key (DEK):** A symmetric AES256 key used to encrypt a partition or block of data. Encrypting each block of data with a different key makes crypto analysis attacks more difficult. Access to DEKs is needed by the resource provider or application instance that is encrypting and decrypting a specific block. When you replace a DEK with a new key, only the data in its associated block must be re-encrypted with the new key.

Key encryption key (KEK): An encryption key used to encrypt the DEKs. A KEK that never leaves Key Vault allows the DEKs themselves to be encrypted and controlled. The entity that has access to the KEK might be different than the entity that requires the DEK. Since the KEK is required to decrypt the DEKs, the KEK is effectively a single point by which DEKs can be effectively deleted by deletion of the KEK. The DEKs, encrypted with the KEKs, are stored separately. Only an entity with access to the KEK can decrypt these DEKs. For more information, see [Security in encryption at](/azure/security/fundamentals/encryption-atrest.md)rest.
## Benefits

Data encryption with customer-managed keys for Azure Database for MySQL Flexible server provides the following benefits:

- Data-access is fully controlled by you by the ability to remove the key and making the database inaccessible
- Full control over the key-lifecycle, including rotation of the key to align with corporate policies
- Central management and organization of keys in Azure Key Vault
- Ability to implement separation of duties between security officers, and DBA and system administrators

## How does data encryption with a customer-managed key work?

:::image type="content" source="media/customer-managed-key-mysql-flexible-server/mysql-customer-managed-key.jpg" alt-text="Diagram of how data encryption with a customer-managed key works.":::

Managed identities in Azure Active Directory (Azure AD) provide Azure services with an automatically managed identity in Azure AD. This identity is used by MySQL Flexible server to authenticate to any service that supports Azure AD authentication, such as [Azure Key Vault](/azure/key-vault/general/overview), without any credentials in the code. Azure Database for MySQL Flexible server currently supports only User-assigned Managed Identity (UMI). For more information, see [Managed identity types](/azure/active-directory/managed-identities-azure-resources/overview#managed-identity-types.md) in Azure.

To configure the customer-managed key in Azure database for MySQL Flexible server, you would need to link UMI and specify the information of Azure Key vault, and key to be used. The UMI should have the following access to key vault. A prerequisite to enable key vault access is to ensure the user-assigned managed identity has been provided the following access:

- **Get**: For retrieving the public part and properties of the key in the key vault.
- **List**: List the versions of the key stored in a Key Vault
- **Wrap Key**: To be able to encrypt the DEK. The encrypted DEK is stored in the Azure Database for MySQL Flexible server.
- **Unwrap Key**: To be able to decrypt the DEK. Azure Database for MySQL Flexible server needs the decrypted DEK to encrypt/decrypt the data

When the flexible server is configured to use the customer-managed key stored in the key vault, the server sends the DEK to the key vault for encryptions. Key Vault returns the encrypted DEK, which is stored in the user database. Similarly, when needed, the Flexible server sends the protected DEK to the key vault for decryption.

A prerequisite to enable key vault access is to ensure the user-assigned managed identity has been provided the following access:

**Get:** For retrieving the public part and properties of the key in the key vault.

**List:** List the versions of the key stored in a Key Vault

**Wrap Key:** To be able to encrypt the DEK. The encrypted DEK is stored in the Azure Database for MySQL Flexible server.

**Unwrap Key:** To be able to decrypt the DEK. Azure Database for MySQL Flexible server needs the decrypted DEK to encrypt/decrypt the data

Auditors can use Azure Monitor to review Key Vault audit event logs, once logging is enabled. Learn how to [enable logging of Key Vault audit events](/azure/key-vault/key-vault-insights-overview.md).

> [!Note]
> It may take around 10 minutes for any permission changes to take effect for the key vault. This includes revoking access permissions to the TDE protector in AKV, and users within this time frame may still have access permissions.

**Requirements for configuring data encryption for Azure Database for MySQL Flexible server**

The following are requirements for configuring Key Vault:

- Key Vault and Azure Database for MySQL flexible server must belong to the same Azure Active Directory (Azure AD) tenant. Cross-tenant Key Vault and flexible server interactions aren't supported. Moving Key Vault resource afterwards requires you to reconfigure the data encryption.
- Enable the [soft-delete](/azure/key-vault/general/soft-delete-overview)feature on the key vault with retention period set to 90 days, to protect from data loss if an accidental key (or Key Vault) deletion happens. Soft-deleted resources are retained for 90 days by default, unless the retention period is explicitly set to \<=90 days. The recover and purge actions have their own permissions associated in a Key Vault access policy. The soft-delete feature is off by default, but you can enable it through the Azure portal, PowerShell or the Azure CLI.
- Enable the [Purge Protection](/azure/key-vault/general/soft-delete-overview#purge-protection.md)feature on the key vault with retention period set to 90 days. Purge protection can only be enabled once soft-delete is enabled. It can be turned on via Azure CLI or PowerShell. When purge protection is on, a vault or an object in the deleted state can't be purged until the retention period has passed.
- Ensure that Key Vault and Azure Database for MySQL Flexible server reside in the same region.

The following are requirements for configuring the customer-managed key:

- The customer-managed key to be used for encrypting the DEK can be only asymmetric, RSA 2048.
- The key activation date (if set) must be a date and time in the past. The expiration date not set.
- The key must be in the **Enabled** state.
- The key must have [soft delete](/azure/key-vault/general/soft-delete-overview.md)with retention period set to **90 days**. This implicitly sets the required key attribute recoveryLevel: "Recoverable". If the retention is set to \< 90 days, the recoveryLevel: "CustomizedRecoverable", which doesn't have the requirement, so ensure to set the retention period is set to **90 days**.
- The key must have [purge protection enabled](/azure/key-vault/general/soft-delete-overview#purge-protection.md).
- If you're [importing an existing key](/rest/api/keyvault/keys/import-key/import-key.md) into the key vault, make sure to provide it in the supported file formats (.pfx, .byok, .backup)

SeeConfigure data encryption for MySQL Flexible server for detailed, step-by-step instructions when you're using the Azure portal.

## Recommendations for configuring data encryption for Azure Database for MySQL Flexible server

Here are recommendations for configuring Key Vault, when you're using data encryption by using a customer-managed key:

- Set a resource lock on Key Vault to control who can delete this critical resource and prevent accidental or unauthorized deletion.
- Enable auditing and reporting on all encryption keys. Key Vault provides logs that are easy to inject into other security information and event management tools. Azure Monitor Log Analytics is one example of a service that's already integrated.
- Keep a copy of the customer-managed key in a secure place or escrow it to the escrow service.
- If Key Vault generates the key, create a key backup before using the key for the first time. You can only restore the backup to Key Vault. For more information about the backup command, see[Backup-AzKeyVaultKey](/powershell/module/az.keyVault/backup-azkeyVaultkey.md).

## Inaccessible customer-managed key condition

When you configure data encryption with a customer-managed key in Key Vault, continuous access to this key is required for the server to stay online. If the flexible server loses access to the customer-managed key in Key Vault, the server begins denying all connections within 10 minutes. The flexible server issues a corresponding error message and changes the server state to _Inaccessible_. Some of the reason the server can reach this state are:

- If you delete the KeyVault, the Azure Database for MySQL Flexible server will be unable to access the key, and will move to _Inaccessible_ state. Recover the [Key Vault](/azure/key-vault/general/key-vault-recovery.md) and revalidate the data encryption to make the Flexible server _Available_.
- If we delete the key from the KeyVault, the Azure Database for MySQL Flexible server will be unable to access the key, and will move to _Inaccessible_ state. Recover the[Key](/azure/key-vault/general/key-vault-recovery.md) and revalidate the data encryption to make the Flexible server _Available_.
- If the key stored in the Azure KeyVault expires, the key will become invalid, and the Azure Database for MySQL Flexible server will transition into _Inaccessible_ state. Extend the key expiry date using [CLI](/cli/azure/keyvault/key#az-keyvault-key-set-attributes.md) and then revalidate the data encryption to make the Flexible server _Available_.

## Accidental key access revocation from Key Vault

It might happen that someone with sufficient access rights to Key Vault accidentally disables flexible server access to the key by:

- Revoking the key vault's got, list, wrap key and unwrap key permissions from the server
- Deleting the key
- Deleting the key vault
- Changing the key vault's firewall rules
- Deleting the user managed identity used for encryption on the flexible server with a customer managed key in Azure AD.

## Monitor the customer-managed key in Key Vault

To monitor the database state, and to enable alerting for the loss of transparent data encryption protector access, configure the following Azure features:

- [Activity log](/azure/service-health/alerts-activity-log-service-notifications-portal): When access to the Customer Key in the customer-managed Key Vault fails, entries are added to the activity log. You can reinstate access as soon as possible if you create alerts for these events.
- [Action groups](/azure/azure-monitor/alerts/action-groups): Define these groups to send you notifications and alerts based on your preferences.

## Restore and replica with a customer's managed key in Key Vault

Once Azure Database for MySQL flexible server is encrypted with a customer's managed key stored in Key Vault, any newly created copy of the server is also encrypted. When trying to encrypt Azure Database for MySQL flexible server with a customer managed key that already has a replica(s), we recommend configuring the replica(s) as well by adding the managed identity and key.

When attempting to restore an Azure Database for MySQL flexible server, you're given the option to select the User managed identity, and Key to encrypt the restore server.

To avoid issues while setting up customer-managed data encryption during restore or read replica creation, it's important to follow these steps on the source and restored/replica servers:

- Initiate the restore or read replica creation process from the source Azure Database for MySQL Flexible server.
- On the restored/replica server, revalidate the customer-managed key in the data encryption settings to ensure that the User managed identity is given Get, List, Wrap key and Unwrap key permissions to the key stored in Key Vault.
